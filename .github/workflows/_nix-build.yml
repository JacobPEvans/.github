# Reusable: Nix Build (macOS)
# Builds a Nix flake on macOS with store caching.
# Default build command targets home-manager; override for darwin-rebuild.
name: _nix-build

on:
  workflow_call:
    inputs:
      build-command:
        description: "Build command to run (default: home-manager build)"
        required: false
        type: string
        default: "nix build .#homeConfigurations.$(whoami).activationPackage --print-build-logs"

concurrency:
  group: nix-build-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            max-jobs = auto
            cores = 0
            http-connections = 50
            connect-timeout = 5
            stalled-download-timeout = 10
            narinfo-cache-positive-ttl = 86400
            fallback = true

      - name: Restore Nix Store Cache
        uses: actions/cache/restore@v5
        id: nix-cache
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: nix-macos-${{ runner.os }}-${{ hashFiles('flake.lock') }}
          restore-keys: |
            nix-macos-${{ runner.os }}-

      - name: Build
        run: ${{ inputs.build-command }}

      - name: Garbage Collect Nix Store
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.nix-cache.outputs.cache-hit != 'true'
        run: |
          echo "Store size before GC: $(du -sh /nix/store | cut -f1)"
          nix-collect-garbage --delete-older-than 1d
          echo "Store size after GC: $(du -sh /nix/store | cut -f1)"

      - name: Save Nix Store Cache
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.nix-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v5
        with:
          path: |
            /nix/store
            ~/.cache/nix
          key: nix-macos-${{ runner.os }}-${{ hashFiles('flake.lock') }}
